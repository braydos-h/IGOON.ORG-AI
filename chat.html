<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>BrainRot AI Chat – Unleash Your Emotions</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Optionally load a modern monospaced font -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
      :root {
        --bg-color: #121212;
        --header-bg: #1e1e1e;
        --accent-color: #bb86fc;
        --text-color: #e0e0e0;
        --muted-color: #aaa;
        --user-msg-bg: #333;
        --ai-msg-bg: #1e1e1e;
        --input-bg: #2e2e2e;
        --font-family: 'Fira Code', 'Courier New', monospace;
      }

      /* Global reset */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* Smooth fade-in animation */
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        font-family: var(--font-family);
        display: flex;
        flex-direction: column;
        height: 100vh;
        animation: fadeIn 1.5s ease-in;
      }

      header {
        background-color: var(--header-bg);
        padding: 20px;
        text-align: center;
        position: relative;
        animation: fadeIn 2s ease-in;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      header img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        margin-right: 10px;
        animation: fadeIn 2s ease-in;
      }

      header .title-container {
        text-align: left;
        flex: 1;
      }

      header .title {
        font-size: 2em;
        letter-spacing: 0.05em;
      }

      header .tagline {
        font-size: 0.9em;
        color: var(--muted-color);
        margin-top: 5px;
      }

      header .glossary-btn {
        padding: 6px 12px;
        border: none;
        border-radius: 5px;
        background-color: var(--ai-msg-bg);
        color: var(--text-color);
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.3s ease;
      }
      
      header .glossary-btn:hover {
        background-color: var(--accent-color);
        transform: translateY(-2px);
      }

      .chat-container {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background-color: var(--bg-color);
      }

      .message {
        max-width: 70%;
        padding: 12px 18px;
        margin: 10px 0;
        border-radius: 10px;
        white-space: pre-wrap;
        word-wrap: break-word;
        animation: fadeIn 1s ease-in;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
      }

      .ai {
        background-color: var(--ai-msg-bg);
        align-self: flex-start;
      }

      .user {
        background-color: var(--user-msg-bg);
        align-self: flex-end;
      }

      .form-container {
        padding: 20px;
        background-color: var(--header-bg);
        animation: fadeIn 2s ease-in;
        box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.6);
      }

      form {
        margin: 0 0 10px 0;
      }

      textarea {
        width: 100%;
        min-height: 80px;
        padding: 12px;
        border: none;
        border-radius: 5px;
        resize: vertical;
        background-color: var(--input-bg);
        color: var(--text-color);
        font-size: 1em;
        font-family: var(--font-family);
      }

      button {
        display: inline-block;
        margin-top: 10px;
        padding: 12px 20px;
        border: none;
        border-radius: 5px;
        background-color: var(--ai-msg-bg);
        color: var(--text-color);
        font-size: 1em;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.3s ease;
      }

      button:hover {
        background-color: var(--accent-color);
        transform: translateY(-2px);
      }

      .clear-button {
        background-color: #555;
      }

      /* Loading bar styles */
      #loadingBar {
        position: fixed;
        top: 0;
        left: 0;
        height: 4px;
        background-color: var(--text-color);
        width: 0%;
        transition: width 0.3s ease;
        z-index: 1001;
      }

      /* Debug panel styles */
      #debugPanel {
        position: fixed;
        bottom: 0;
        right: 0;
        background-color: rgba(30, 30, 30, 0.9);
        color: var(--muted-color);
        padding: 10px;
        font-size: 0.8em;
        z-index: 1001;
        border-top-left-radius: 8px;
        line-height: 1.4em;
      }

      /* Slang Glossary Modal Styles */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.85);
        animation: fadeIn 0.5s ease-in;
      }

      .modal-content {
        background-color: var(--header-bg);
        margin: 10% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 80%;
        border-radius: 10px;
        color: var(--text-color);
        max-height: 60%;
        overflow-y: auto;
      }

      .modal-content h2 {
        margin-top: 0;
        font-size: 1.5em;
      }

      .modal-content ul {
        list-style: none;
        padding: 0;
      }

      .modal-content li {
        margin: 10px 0;
        line-height: 1.4em;
      }

      .close {
        color: var(--muted-color);
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover {
        color: var(--text-color);
      }

      /* Mode selection buttons styling */
      #modeSelector {
        margin-bottom: 10px;
      }
      .mode-button {
        padding: 8px 16px;
        margin-right: 5px;
        border: none;
        border-radius: 5px;
        background-color: var(--ai-msg-bg);
        color: var(--text-color);
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.3s ease;
      }
      .mode-button:hover {
        background-color: var(--accent-color);
        transform: translateY(-2px);
      }
      .mode-button.active {
        background-color: var(--accent-color);
      }
    </style>
  </head>
  <body>
    <!-- Loading bar -->
    <div id="loadingBar"></div>
    
    <header>
      <img src="https://i.pinimg.com/736x/d8/99/5d/d8995dedd69d6972e4ea144ba27db6f8.jpg" alt="Profile">
      <div class="title-container">
        <div class="title">BrainRot AI Chat</div>
        <div class="tagline">Your Digital Confidant for Unleashing True Emotions</div>
      </div>
      <button class="glossary-btn" id="openGlossary">Glossary</button>
    </header>

    <div class="chat-container" id="chatbox">
      <!-- Existing chat history rendered server-side -->
      {% for msg in chat_history %}
        <div class="message {{ msg.sender }}">{{ msg.text }}</div>
      {% endfor %}
    </div>

    <div class="form-container">
      <!-- Mode selector buttons -->
      <div id="modeSelector">
        <button type="button" class="mode-button active" data-mode="nerd">Nerd Mode</button>
        <button type="button" class="mode-button" data-mode="brainrot">Brainrot Mode</button>
        <button type="button" class="mode-button" data-mode="maxbrainrot">Max BrainRot Mode</button>
      </div>
      <form id="chatForm">
        <textarea name="prompt" id="promptInput" placeholder="Share your thoughts..."></textarea>
        <button type="submit">Send Message</button>
      </form>
      <form method="post" action="/clear">
        <button type="submit" class="clear-button">Clear Chat</button>
      </form>
    </div>
    
    <!-- Expanded Debug panel -->
    <div id="debugPanel">
      Online: <span id="onlineCount">--</span><br>
      Time: <span id="debugInfo">Initializing...</span><br>
      CPU: <span id="cpuUsage">--</span>%<br>
      RAM: <span id="ramUsage">--</span>%<br>
      Disk: <span id="diskUsage">--</span>%<br>
      Ping: <span id="ping">--</span> ms<br>
      WiFi: <span id="wifi">--</span>
    </div>
    
    <!-- Slang Glossary Modal -->
    <div id="glossaryModal" class="modal">
      <div class="modal-content">
        <span class="close" id="closeGlossary">&times;</span>
        <h2>Slang Glossary</h2>
        <ul>
          <li><strong>icl:</strong> i couldnt lie.</li>
          <li><strong>pmo:</strong> piss me off.</li>
          <li><strong>ts:</strong> this shit/ this.</li>
          <li><strong>ngl:</strong> not gonna lie.</li>
          <li><strong>rn:</strong> right now – in the moment.</li>
          <li><strong>fr:</strong> for real – genuine emotions.</li>
          <li><strong>b fr:</strong> be real.</li>
          <li><strong>h8:</strong> hate.</li>
          <li><strong>idek:</strong> i don't even know.</li>
          <li><strong>anm:</strong> another moment.</li>
          <li><strong>mn:</strong> man, this is tough.</li>
          <li><strong>js:</strong> just saying it as it is.</li>
          <li><strong>vro:</strong> very real ones only.</li>
          <li><strong>sb:</strong> somebody, somewhere, cared.</li>
          <li><strong>atp:</strong> at this point, it's over.</li>
          <li><strong>oms:</strong> oh, my soul is shattered.</li>
          <li><strong>sybau:</strong> see ya – i'm off.</li>
          <li><strong>lol:</strong> laughing out loud in distress.</li>
        </ul>
      </div>
    </div>
    
    <script>
      // Glossary modal functionality
      const glossaryModal = document.getElementById("glossaryModal");
      const openGlossaryBtn = document.getElementById("openGlossary");
      const closeGlossaryBtn = document.getElementById("closeGlossary");

      openGlossaryBtn.onclick = () => {
        glossaryModal.style.display = "block";
      };

      closeGlossaryBtn.onclick = () => {
        glossaryModal.style.display = "none";
      };

      window.onclick = (event) => {
        if (event.target === glossaryModal) {
          glossaryModal.style.display = "none";
        }
      };

      // Mode selection logic
      let selectedMode = "nerd"; // Default mode

      const modeButtons = document.querySelectorAll('.mode-button');
      modeButtons.forEach(button => {
        button.addEventListener('click', () => {
          // Remove active class from all buttons and add to the clicked button
          modeButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          selectedMode = button.getAttribute('data-mode');
        });
      });

      // Handle chat form submission with AJAX and live streaming update
      const chatForm = document.getElementById('chatForm');
      const promptInput = document.getElementById('promptInput');
      const chatbox = document.getElementById('chatbox');
      const loadingBar = document.getElementById('loadingBar');

      chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const promptText = promptInput.value.trim();
        if (!promptText) return;
        
        // Add user message immediately to the chatbox
        const userMsgDiv = document.createElement('div');
        userMsgDiv.classList.add('message', 'user');
        userMsgDiv.textContent = promptText;
        chatbox.appendChild(userMsgDiv);
        chatbox.scrollTop = chatbox.scrollHeight;

        // Clear the textarea
        promptInput.value = '';

        // Create an element for the AI response
        const aiMsgDiv = document.createElement('div');
        aiMsgDiv.classList.add('message', 'ai');
        aiMsgDiv.textContent = '';
        chatbox.appendChild(aiMsgDiv);
        chatbox.scrollTop = chatbox.scrollHeight;

        // Show the loading bar and animate it
        loadingBar.style.width = "20%";
        loadingBar.style.display = "block";

        // Post the prompt and selected mode to the /generate endpoint and process the streamed response
        fetch('/generate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ prompt: promptText, mode: selectedMode })
        }).then(response => {
          const reader = response.body.getReader();
          const decoder = new TextDecoder();
          let receivedLength = 0;
          
          function readStream() {
            reader.read().then(({ done, value }) => {
              if (done) {
                loadingBar.style.width = "100%";
                setTimeout(() => { 
                  loadingBar.style.display = "none"; 
                  loadingBar.style.width = "0%";
                }, 500);
                return;
              }
              const chunk = decoder.decode(value);
              receivedLength += value.length;
              aiMsgDiv.textContent += chunk;
              chatbox.scrollTop = chatbox.scrollHeight;
              
              // Update loading bar width dynamically (optional)
              let width = 20 + (receivedLength % 80);
              loadingBar.style.width = width + "%";
              
              readStream();
            });
          }
          readStream();
        }).catch(err => {
          console.error("Error streaming response:", err);
          aiMsgDiv.textContent = "Error during generation.";
          loadingBar.style.display = "none";
        });
      });

      // Debug panel updater: poll the /debug endpoint every 5 seconds
      function updateDebugPanel() {
        fetch('/debug')
          .then(res => res.json())
          .then(data => {
            document.getElementById('onlineCount').textContent = data.users_online;
            document.getElementById('debugInfo').textContent = data.debug_info;
            document.getElementById('cpuUsage').textContent = data.cpu_usage;
            document.getElementById('ramUsage').textContent = data.ram_usage;
            document.getElementById('diskUsage').textContent = data.disk_usage;
            document.getElementById('ping').textContent = data.ping;
            document.getElementById('wifi').textContent = data.wifi;
          })
          .catch(err => console.error("Error fetching debug info:", err));
      }
      setInterval(updateDebugPanel, 5000);
      updateDebugPanel();
    </script>
  </body>
</html>
